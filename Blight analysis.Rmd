---
title: "Blight analysis"
author: "Pawe≈Ç Stradowski"
date: "31.03.2016"
output: html_document
---
```{r}
Sys.setlocale("LC_MESSAGES", "en_US.utf8")
Sys.setlocale("LC_ALL", "en_US.utf8")
#data_path <- '~/datasci_course_materials/capstone/blight/data/'
data_path <- '/home/pawel/Documents/datasci_course_materials/capstone/blight/data/'
detroit.311 <- read.csv(paste0(data_path, "detroit-311.csv"))
violations <- read.csv(paste0(data_path, "detroit-blight-violations.csv"))
crime <- read.csv(paste0(data_path, "detroit-crime.csv"))
demolitions <- read.delim(paste0(data_path, "detroit-demolition-permits.tsv"))
load("boundary.RData")
library("dplyr")
library("leaflet")
library("tidyr")
library("fuzzyjoin")
library("magrittr")
library("geohash")
```

Addresses extraction from violations
``` {r}

parse_addr <- function(df, col){
  df %>% 
    separate_(col, into=c("addr", "loc"), sep="\\(") %>%
    tidyr::extract(loc, into = c("lat", "lon"), 
          regex = "(\\d+\\.\\d+),\\s(\\-*\\d+\\.\\d+)", perl = TRUE) %>%
  mutate(lat=as.numeric(lat), lon=as.numeric(lon)) %>%
  mutate(addr = sub("\n.+", "", addr)) 
 }

enrich <- function(df) {
  df %>% filter(lat<max(boundary$lat), 
                    lat > min(boundary$lat), 
                    lon > min(boundary$lon), 
                    lon < max(boundary$lon)) %>%
    mutate(geohash = gh_encode(lat, lon, 8)) %>%
    mutate(gh6 = substr(geohash, 1, 6),
         gh7 = substr(geohash, 1, 7))
}

violations %<>% parse_addr("ViolationAddress") %>% 
  enrich() 
  
crime %<>% rename(lat = LAT, lon = LON, addr = ADDRESS) %>% 
  enrich() 
  
demolitions %<>% parse_addr("site_location") %>% 
  enrich() 

detroit.311 %<>% rename(lon = lng) %>%
  enrich()
  
```

```{r}
blight <-demolitions %>% distinct(geohash) %>%
  select(geohash, gh6, gh7) %>%
  mutate(blighted = 1) 


all_events <- crime %>% select(geohash, gh6, gh7) %>%
  bind_rows(violations %>% select(geohash, gh6, gh7)) %>%
  distinct(geohash) 

non_blight <- anti_join(all_events, blight, by="gh7") %>%
  select(geohash, gh6, gh7) %>%
  mutate(blighted = 0)

data_set <- non_blight %>%
  sample_n(nrow(blight), replace = FALSE) %>% 
  bind_rows(blight)

ds <- violations  %>% select(geohash) %>%
  right_join(data_set, by="geohash") %>% 
  group_by(geohash) %>% summarise(cnt = n()) %>%  
  right_join(data_set, by="geohash") %>% 
  mutate(feat1 = ifelse(is.na(cnt), 0, cnt)) %>% 
  select(blighted, feat1) %>%
  mutate(blighted = factor(blighted))

inTraining <- createDataPartition(data_set$blighted, p=.75, list = FALSE)
tr <-data_set[inTraining,]
ts <- data_set[-inTraining,]


```